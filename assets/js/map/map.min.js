/*
* A–Gain Guide Map
* Copyright 2022 Cecilia Palmer 
* mail@ceciliapalmer.studio
* https://ceciliapalmer.studio
*
* This program is free software: you can redistribute it and/or modify it under the terms 
* of the GNU General Public License as published by the Free Software Foundation, version 3 or later.
* This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; 
* without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
* See the GNU General Public License for more details.

* You should have received a copy of the GNU General Public License along with this program. If not, see https://www.gnu.org/licenses/.
*
*/
const userlang=document.getElementsByTagName("html")[0].getAttribute("lang"),labels={submit:{de:"Apply",en:"Apply"},reset:{de:"Reset",en:"Reset"},address:{de:"Adresse",en:"Address"},phone:{de:"Fon",en:"Phone"},email:{de:"E-mail",en:"Email"},search:{de:"SUCHE",en:"SEARCH"},district:{de:"Bezirk",en:"District"},service:{de:"Service",en:"Service"}},serviceName="firmenname",offers="de"==userlang?"serviceAngebote":"serviceAngeboteEN",service1="de"==userlang?"service1":"service1EN",service2="de"==userlang?"service2":"service2EN",service3="de"==userlang?"service3":"service3EN",serviceType="serviceArt",hours="de"==userlang?"ffnungszeiten":"ffnungszeitenEN",products="de"==userlang?"produkte":"produkteEN",extras="de"==userlang?"extras":"extrasEN",infos="de"==userlang?"hinweise":"hinweiseEN",district="bezirk",address="adresse",zipcode="postleitzahl",phone="telefon";function onEachFeature(e,t){t.on({click:()=>{featureLayer.resetStyle(),t.setStyle(activeStyle).bringToFront()}}),window.innerWidth>800?t.bindTooltip(e.properties[serviceName]):createPopup(e,t)}function createPopup(e,t){const r=L.DomUtil.create("div","listItem"),i=createItemContent(r,e);L.DomEvent.on(r,"click",(e=>{e.target.classList.toggle("active")}));const o=L.popup({autoPanPaddingTopLeft:[15,165]}).setContent(i);t.bindPopup(o)}function createItemContent(e,t){const r=t.properties;if(L.DomUtil.create("h3","",e).innerHTML=r.firmenname,[service1,service2,service3].forEach((t=>{if(r.hasOwnProperty(t)){L.DomUtil.create("span","itemCat",e).innerHTML=r[t]}})),r.hasOwnProperty("serviceArt")&&"Online"==r.serviceArt){L.DomUtil.create("div","online-note",e).innerHTML="Online service"}r.hasOwnProperty(address)&&"Online"!==r.serviceArt&&(L.DomUtil.create("div","address",e).innerHTML=`<h4>${labels.address[userlang]}</h4><p>${r[address]}<br>${r[zipcode]} Berlin-${r[district]}</p>`);let i=[r[phone],r[email],r[hours],r[website],r[facebook],r[instagram],r[offers],r[products],r[extras],r[infos]];if(i=i.filter((e=>e)),0!==i.length){e.classList.add("collapsible");let t=L.DomUtil.create("div","moreInfo",e);if(r[phone]){L.DomUtil.create("div","",t).innerHTML=`<h4>${labels.phone[userlang]}</h4><p><a href="callto:${r[phone]} " target="_blank">${r[phone]}</a></p>`}if(r.hasOwnProperty(email)){L.DomUtil.create("div","",t).innerHTML=`<h4>${labels.email[userlang]}</h4><p><a href="mailto:${r.email}" target="_blank">${r.email}</a></p>`}if(r.hasOwnProperty(hours)){L.DomUtil.create("div","",t).innerHTML=`<h4>Open</h4><p>${r[hours]}</p>`}let i=L.DomUtil.create("div","links",t);if(r.hasOwnProperty(website)){const e=L.DomUtil.create("a","",i);e.setAttribute("target","_blank"),e.href=r.website.startsWith("http")?r.website:`https://${r.website}`,e.innerHTML="Website"}if(r.hasOwnProperty(facebook)){const e=L.DomUtil.create("a","",i);e.setAttribute("target","_blank"),e.href=`https://facebook.com/${r.facebook}`,e.innerHTML="FB"}if(r.hasOwnProperty(instagram)){const e=L.DomUtil.create("a","",i);e.setAttribute("target","_blank"),e.setAttribute("href",`https://instagram.com/${r.instagram}`),e.innerHTML="IG"}let o=[r[offers],r[products],r[extras],r[infos]].filter((e=>e));if(0!==o.length){L.DomUtil.create("h4","",t).innerHTML="Info";let e=L.DomUtil.create("ul","",t);o.forEach((t=>{if(""!==t){L.DomUtil.create("li","",e).innerHTML=t}}))}}return e}email="email",website="website",facebook="facebook",instagram="instagram";const activeStyle={fillColor:"#F7ED74",zIndexOffset:999};let featureLayer,featureList,paddingLeft=10,markerSize=20,clusterRadius=1e3,dotMarker={radius:markerSize/2,color:"#2b2e34",fillColor:"#2b2e34",weight:1,opacity:1,fillOpacity:1,zIndexOffset:0};const markerClusterOptions={maxClusterRadius:function(e){return 80},disableClusteringAtZoom:15,showCoverageOnHover:!1,spiderfyOnMaxZoom:!1,iconCreateFunction:function(e){return L.divIcon({html:"<span>"+e.getChildCount()+"</span>",iconSize:e.getChildCount()>100?2*markerSize+100:2*markerSize+e.getChildCount(),className:"marker-cluster"})},polygonOptions:{fillColor:"#000",color:"transparent",weight:.5,opacity:1,fillOpacity:.15}};function howFar(e,t){const r=L.latLng(e.geometry.coordinates),i=L.latLng(t),o=r.distanceTo(i);return Math.floor(o/1e3)}function setSidebarHeight(){const e=window.innerHeight-document.querySelector(".leaflet-top.leaflet-left").offsetTop;document.documentElement.style.setProperty("--sidebar-height",`${e}px`)}function initMap(e){filters.service.de=getServiceValues(e,"de"),filters.service.en=getServiceValues(e,"en"),filters.district.de=filters.district.en=getDistrictValues(e);let t={zoomControl:!1,layers:[L.tileLayer("https://api.mapbox.com/styles/v1/a-gainguide/cl0jz9gbd006h14qbnhi3pi67/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiYS1nYWluZ3VpZGUiLCJhIjoiY2t3NTA1cDh6MGJ0cjJvbGpkN3l6cmRsOCJ9.uc3-GBViacpGa3BnZ0GAiQ",{tileSize:512,zoomOffset:-1,detectRetina:!0,attribution:'Mapdata <a href="https://www.mapbox.com/about/maps/">© Mapbox</a> | <a href="http://www.openstreetmap.org/about/">© OpenStreetMap</a>'})],minZoom:10,tap:!1},r=L.map("map",t).setView([52.5208,13.3942],11);L.control.zoom({position:"bottomright"}).addTo(r);let i=.25*window.innerWidth;paddingLeft=window.innerWidth<768?0:i,featureLayer=L.geoJSON(e,{pointToLayer:(e,t)=>L.circleMarker(t,dotMarker),onEachFeature:onEachFeature}),featureLayer._data=e,featureLayer._filters=filters;let o=L.markerClusterGroup(markerClusterOptions),a=new L.Control.Search({position:"topleft",layer:o,propertyName:"firmenname",initial:!1,marker:!1,collapsed:!1,textPlaceholder:labels.search[userlang],moveToLocation:function(e,t,r){r.setView(e,16)}});const n=new L.Control.FilterToggle({position:"topleft"});o.addLayer(featureLayer),r.addControl(a),n.addTo(r);let s=L.control.filterfeatures({lang:userlang,layer:featureLayer,clusterLayer:o});s.addTo(r),featureList=L.control.featurelist({layer:featureLayer,randomOrder:!0,featureName:"firmenname",listItemFunction:createItemContent}),featureList.addTo(r),s.on("filter:apply",(()=>{featureList.updateList()})).on("filter:reset",(()=>{featureList.updateList()})),a.on("search:locationfound",(e=>{e.layer.setStyle(activeStyle),featureList.goToItem(e.layer.item,e.layer),e.layer.fire("mouseover")})).on("search:cancel",(()=>{featureLayer.eachLayer((function(e){featureLayer.resetStyle(e),e.fire("mouseout")}))})),r.addLayer(o);const l=document.querySelector(".leaflet-control-container .leaflet-top.leaflet-left").clientHeight;document.documentElement.style.setProperty("--search-container-height",`${l}px`),document.querySelectorAll('.filter__list input[type="checkbox"]').forEach((e=>{e.addEventListener("change",(function(){document.querySelector(".reset__filters").classList.remove("disabled")}))}));const c=document.querySelector(".leaflet-top.leaflet-left");screen.width<800&&c.classList.add("show-map"),document.querySelectorAll("#viewSwitch div").forEach((e=>{e.addEventListener("click",(e=>{document.querySelectorAll("#viewSwitch div").forEach((e=>{e.classList.toggle("activeView")})),document.querySelector("#viewMap").classList.contains("activeView")?c.classList.add("show-map"):c.classList.remove("show-map")}))})),document.querySelectorAll(".leaflet-top.leaflet-left").length>0&&setSidebarHeight()}function getServiceValues(e,t){let r={},i=[];const o=e.features;for(let e,t=0;e=o[t++];){[e.properties[service1],e.properties[service2],e.properties[service3]].forEach((e=>{e in r||""===e||void 0===e||(r[e]=1,i.push(e))}))}return i.sort(),"de"==t&&i.unshift(i.pop()),i}function getDistrictValues(e){let t={},r=[];const i=e.features;for(let e,o=0;e=i[o++];){let i=e.properties.bezirk;i in t||""===i||(t[i]=1,r.push(i))}return r.sort(),r}function fetchResults(e){fetch(e).then((e=>e.json())).then((e=>{initMap(e)})).catch((e=>{console.log(e)}))}window.addEventListener("resize",(()=>{clearTimeout(timeout),timeout=setTimeout(setSidebarHeight(),delay)})),L.Control.FilterToggle=L.Control.extend({onAdd:function(e){const t=L.DomUtil.create("div","mobile-only show-filter");return t.addEventListener("click",(e=>{e.target.parentNode.classList.toggle("show-filters")})),t},onRemove:function(e){}});